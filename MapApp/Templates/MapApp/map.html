<!DOCTYPE html>
<html lang="en">
<head>
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
          integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <style>

        html {
            height: 96%
        }

        body {
            height: 93%;
            margin: 0;
            padding: 0;
        }

        #container {
            width: 100%;
            height: 100%
        }

        #nav {
            z-index: 100;
            position: absolute;
            padding: 5;
            position: fixed;
            top: 20%;
            left: 0;
            width: < fixed px >;
            height: < fixed px >;
        }

        #map {
            height: 100%
        }

        h1 {
            text-align: center;
            text-shadow: firebrick;
        }

        h3 {
            text-align: center;
            text-shadow: ghostwhite;
        }

    </style>
    {% load static %}
</head>
<body>
<div id="container">


    <div id="nav">

        <h3>KeyWord</h3>

        <form id="listform" method="POST">{% csrf_token %}
            <select name="KeyWords" class="form-control" id="KeyWords">
                <option value="Sports" selected>Sports</option>
                <option value="Game">Game</option>
                <option value="Weather">Weather</option>
                <option value="Food">Food</option>
                <option value="Fun">Fun</option>
                <option value="Traffic">Traffic</option>
                <option value="Location">Location</option>
                <option value="App">App</option>
                <option value="Company">Company</option>
            </select>
            <br>
            <div style="position:absolute;vertical-align:middle;text-align:center;">
                <button type="submit" class="btn btn-primary" style="width:100px" onsubmit="initMap()">Search</button>
            </div>
        </form>

    </div>
    <h1>{{ app_name }}</h1>
    <div id="map"></div>

</div>
<script>

    function initMap() {
        var center = {lat: 20, lng: 150.644};
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 2,
            center: center,
            mapTypeId: 'roadmap',
            scaleControl: true,
            streetViewControl: true,
            rotateControl: true,
            fullscreenControl: true
        });

        {#---Ajax---#}
        $('#listform').on('submit', function (event) {
            event.preventDefault();
            var key_word = document.getElementById("KeyWords");
            key_word_value = key_word.options[key_word.selectedIndex].value;
            $.ajax({
                url: '/handle/',
                type: 'POST',
                data: {Search: key_word_value, csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()},

                success: function (json) {
                    var map = new google.maps.Map(document.getElementById('map'), {
                        zoom: 2,
                        center: center,
                        mapTypeId: 'roadmap',
                        scaleControl: true,
                        streetViewControl: true,
                        rotateControl: true,
                        fullscreenControl: true
                    });
                    
                    for (i = 0; i < json.length.hits; i++) {
                        var latlng = new google.maps.LatLng(parseFloat(json.coordinates[i].lat),
                            parseFloat(json.coordinates[i].lng));
                        var contentString = json.twitts[i];

                        var marker = new google.maps.Marker({
                            map: map,
                            position: latlng,
                            animation: google.maps.Animation.DROP,
                            title: 'Title'
                        });

                        addInfo(marker, contentString);
                        marker.setMap(map);
                    }

                }
            });
        });
    }

    function addInfo(marker, contentString) {
        var infowindow = new google.maps.InfoWindow({
            content: contentString
        });
        marker.addListener('click', function () {
            infowindow.open(map, marker);
        })
    }


</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDi0C_QfGBtgmTCKCa68I7Q8t6K6wb14Q&callback=initMap">
</script>
</body>
</html>
